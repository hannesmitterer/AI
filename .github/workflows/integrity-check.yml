name: Binary Integrity Monitoring

on:
  push:
    branches:
      - main
      - master
  pull_request:
  schedule:
    # Run integrity checks daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  integrity-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Generate Current Checksums
        id: checksums
        run: |
          echo "## Binary Integrity Report" > integrity-report.md
          echo "" >> integrity-report.md
          echo "**Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> integrity-report.md
          echo "" >> integrity-report.md
          
          # Find all binary files
          BINARY_COUNT=0
          for file in *.bin; do
            if [ -f "$file" ]; then
              BINARY_COUNT=$((BINARY_COUNT + 1))
              HASH=$(sha256sum "$file" | cut -d' ' -f1)
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
              
              echo "### $file" >> integrity-report.md
              echo "- **SHA256**: \`$HASH\`" >> integrity-report.md
              echo "- **Size**: $SIZE bytes" >> integrity-report.md
              echo "- **Status**: âœ… Verified" >> integrity-report.md
              echo "" >> integrity-report.md
              
              # Store for comparison
              echo "$file|$HASH|$SIZE" >> current-checksums.txt
            fi
          done
          
          echo "binary_count=$BINARY_COUNT" >> $GITHUB_OUTPUT
          cat integrity-report.md
          
      - name: Verify Integrity Against Known Good Hashes
        id: verify
        run: |
          # Known good hash for euystacio.core.v2.bin
          KNOWN_HASH="ad191eaed965a47cb6cf75a3b319b5af015fb9757b0d96beb1038a31f72bb069"
          
          if [ -f "euystacio.core.v2.bin" ]; then
            CURRENT_HASH=$(sha256sum euystacio.core.v2.bin | cut -d' ' -f1)
            
            if [ "$CURRENT_HASH" = "$KNOWN_HASH" ]; then
              echo "âœ… euystacio.core.v2.bin integrity verified"
              echo "status=verified" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  WARNING: euystacio.core.v2.bin hash mismatch!"
              echo "Expected: $KNOWN_HASH"
              echo "Got: $CURRENT_HASH"
              echo "status=mismatch" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸  euystacio.core.v2.bin not found"
            echo "status=missing" >> $GITHUB_OUTPUT
          fi
          
      - name: Check for Unauthorized Modifications
        run: |
          echo "## Change Detection" >> integrity-report.md
          echo "" >> integrity-report.md
          
          # Get list of changed binary files in this commit
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_BINS=$(git diff --name-only HEAD~1 HEAD | grep "\.bin$" || true)
            
            if [ -n "$CHANGED_BINS" ]; then
              echo "âš ï¸  **Binary files modified in this commit:**" >> integrity-report.md
              echo "\`\`\`" >> integrity-report.md
              echo "$CHANGED_BINS" >> integrity-report.md
              echo "\`\`\`" >> integrity-report.md
            else
              echo "âœ… No binary files modified in this commit" >> integrity-report.md
            fi
          fi
          
          cat integrity-report.md
          
      - name: Upload Integrity Report
        uses: actions/upload-artifact@v4
        with:
          name: integrity-report-${{ github.run_number }}
          path: |
            integrity-report.md
            current-checksums.txt
          retention-days: 90
          
      - name: Create Issue on Integrity Failure
        if: steps.verify.outputs.status == 'mismatch' || steps.verify.outputs.status == 'missing'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.verify.outputs.status }}';
            const title = `ðŸ” Binary Integrity Alert: ${status}`;
            const body = `## Binary Integrity Check Failed
            
            **Status**: ${status}
            **Workflow**: ${{ github.workflow }}
            **Run ID**: ${{ github.run_id }}
            **Triggered by**: ${{ github.event_name }}
            
            ### Action Required
            
            ${status === 'mismatch' ? 'Binary file hash does not match expected value. Potential unauthorized modification detected.' : 'Binary file is missing from repository.'}
            
            ### Details
            
            - Repository: ${{ github.repository }}
            - Branch: ${{ github.ref }}
            - Commit: ${{ github.sha }}
            
            Please investigate immediately and verify the integrity of binary assets.
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'integrity-check']
            });
            
      - name: Integrity Summary
        run: |
          echo "## Integrity Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Binary Files Checked**: ${{ steps.checksums.outputs.binary_count }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Verification Status**: ${{ steps.verify.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify.outputs.status }}" = "verified" ]; then
            echo "ðŸ” All binary assets passed integrity verification" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Integrity issues detected - please review the report" >> $GITHUB_STEP_SUMMARY
          fi
